Ext.ns("Ext.plugin.GMap");Ext.plugin.GMap.Tracker=Ext.extend(Ext.util.Observable,{autoUpdate:true,ptype:"gmaptracker",trackSuspended:false,highAccuracy:false,updateInterval:90000,constructor:function(config){Ext.apply(this,config||{});if(Ext.supports.GeoLocation){this.provider=this.provider||(navigator.geolocation?navigator.geolocation:(window.google||{}).gears?google.gears.factory.create("beta.geolocation"):null);}this.addEvents("beforeupdate","update","exception");Ext.plugin.GMap.Tracker.superclass.constructor.call(this);this.onError=Ext.createDelegate(this.onError,this);this.onPosition=Ext.createDelegate(this.onPosition,this);this.updateLocation=Ext.createDelegate(this.updateLocation,this);if(this.autoUpdate){this.startUpdates();}},init:function(host){if(host&&typeof host.renderMap=="function"){this.host=host;host.geo=this;Ext.apply(host,{suspendUpdates:Ext.createDelegate(this.suspendUpdates,this),resumeUpdates:Ext.createDelegate(this.resumeUpdates,this),setHighAccuracy:Ext.createDelegate(this.setHighAccuracy,this)});host.on({maprender:this.onMapRender,resize:this.onResized,scope:this});this.on("update",this.updateTrack,this);}},setHighAccuracy:function(accuracy){var h=!!this.highAccuracy;this.highAccuracy=!!accuracy;if((h!==this.highAccuracy)&&this.watchId){this.provider.clearWatch(this.watchId);this.startUpdates();}return this;},startUpdates:function(){if(Ext.supports.GeoLocation&&"watchPosition" in this.provider){this.watchId=this.provider.watchPosition(this.onPosition,this.onError,{allowHighAccuracy:!!this.highAccuracy,maximumAge:this.updateInterval||60000,gearsLocationProviderUrls:null});}else{this.updateLocation();this.pollId=this.updateInterval?setInterval(this.updateLocation,this.updateInterval):null;}return this;},updateTrack:function(tracker,coords){this.getMarker().setPosition(coords);this.trackSuspended||this.host.update(coords);},suspendUpdates:function(){this.trackSuspended=true;},resumeUpdates:function(){this.trackSuspended=false;this.updateTrack(this,this.coords);},onMapRender:function(host,map){var marker=this.getMarker();if(marker){marker.setMap(map);}},onResized:function(host,w,h){if(host.map){this.trackSuspended||this.host.update(this.coords);}},getMarker:function(){var gm=(window.google||{}).maps;if(gm&&this.host&&!this.marker){this.marker=new gm.Marker({position:this.coords||this.host.mapOptions.center});}return this.marker;},getLocation:function(callback,scope){var me=this;if(Ext.supports.GeoLocation&&!me.coords){me.updateLocation(callback,scope);}else{if(callback){setTimeout(function(){callback.call(scope||me,Ext.supports.GeoLocation?me.coords:null,me);},0);}}},updateLocation:function(callback,scope){var me=this;if(Ext.supports.GeoLocation){me.fireEvent("beforeupdate",me);me.provider.getCurrentPosition(function(position){me.onPosition(position);if(callback){callback.call(scope||me,me.coords,me);}},me.onError,{allowHighAccuracy:!!me.highAccuracy,maximumAge:me.updateInterval||60000,gearsLocationProviderUrls:null});}else{setTimeout(function(){me.onPosition();if(callback){callback.call(scope||me,null,me);}},0);}},onPosition:function(position){var me=this;me.coords=me.parseCoords(position);me.fireEvent("update",me,me.coords);},onError:function(error){this.fireEvent("exception",this,error);},parseCoords:function(location,asObject){var coords=location&&location.coords?{latitude:location.coords.latitude,longitude:location.coords.longitude,original:location}:this.coords;if(coords&&asObject!==false&&(window.google||{}).maps){coords=new google.maps.LatLng(coords.latitude,coords.longitude);}return(this.coords=coords);},destroy:function(){this.updateInterval=0;if(Ext.supports.GeoLocation&&this.watchId){this.provider.clearWatch(this.watchId);}if(this.pollId){clearInterval(this.pollId);}this.provider=null;}});Ext.preg("gmaptracker",Ext.plugin.GMap.Tracker);