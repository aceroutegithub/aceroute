Ext.AceRoute.view.cfg={};var appTabPanelGlobal;var orderMapPanelGlobal;var orderDataGlobal;Ext.AceRoute.view.OfflineStore=new Ext.data.Store({model:"OfflineData",autoLoad:true});Ext.AceRoute.view.SpeakerStore=new Ext.data.Store({model:"Speaker",getGroupString:function(r){return r.get("last_name")[0];}});Ext.AceRoute.view.AppTabPanel=Ext.extend(Ext.TabPanel,{id:"appTabPanelId",fullscreen:true,tabBar:{ui:"gray",dock:"bottom",layout:{pack:"center"}},cardSwitchAnimation:false,_controller:null,systemOperationOptionSelected:"refreshOrders",initComponent:function(){if(navigator.onLine){var jobsListView=new Ext.AceRoute.view.SessionListXml({id:"orderListXmlId",name:"orderListXml",iconCls:"doc_list",height:60,title:"Jobs",confTitle:this.title,shortUrl:this.shortUrl});jobsListView.setMvcController(this._controller);var backDateButton=new Ext.SegmentedButton({items:[{text:"Previous",dateData:"Previous",ui:"back",scope:this,handler:this.goDateBack}],defaults:{flex:1},style:"width: 100%"});var nextDateButton=new Ext.SegmentedButton({items:[{text:"Next",dateData:"Next",ui:"forward",scope:this,handler:this.goDateNext}],defaults:{flex:1},style:"width: 100%"});var dateButtons=new Ext.SegmentedButton({items:[backDateButton,nextDateButton],defaults:{flex:1},style:"width: 100%"});var mapPanel=new Ext.Panel({id:"orderMapId",name:"orderMap",title:"Route",iconCls:"compass3",items:[],listeners:{activate:{fn:function(){function mapObj(){this.geoCode;this.seqLabel;this.iconClr;this.orderStartDate;this.orderStartTime;this.orderAddress;this.orderName;}var mapObjArray=new Array();var orderListTab=this.getComponent("orderListXmlId");var orderList;if(typeof orderListTab.list!=="undefined"){var store=orderListTab.list.store;if(typeof store!=="undefined"){store.sort("start_time_millisec","ASC");var data=store.data;if(typeof data!=="undefined"){var items=data.items;if(items!=null){orderList=items;for(var i=0;i<items.length;i++){var mObj=new mapObj();var data=items[i].data;mObj.geoCode=data.site_geocode;console.log(" start start_time_millisec date "+data.start_time_millisec);console.log(" start start_time "+data.start_time);mObj.seqLabel=i+1;var current_date=new Date();var start_date=new Date(data.start_date);var end_date=new Date(data.end_date);var iconClr=CommonUtil.getIconColor(current_date,start_date,end_date,data.order_wkfid);mObj.iconClr=iconClr;mObj.orderStartDate=data.start_dateWithoutTime;mObj.orderStartTime=data.start_time;mObj.orderAddress=data.site_addr.formatAddress(",");mObj.orderId=data.id;mObj.orderName=data.order_name;mapObjArray.push(mObj);}this.setMapObjArray(mapObjArray);}}}}var orderData=undefined;if(!this._controller.isMapRenderingCompleteOnAddressClick){this._controller.refreshMapTab(orderData,mapObjArray);this._controller.isMapRenderingCompleteOnAddressClick=false;}if(this._controller.isMapRenderingCompleteOnAddressClick){this._controller.isMapRenderingCompleteOnAddressClick=false;}},scope:this}},});var systemPanel=new Ext.Panel({id:"systemPanelId",name:"systemPanel",title:"System",iconCls:"action",items:[{xtype:"panel",items:[{xtype:"fieldset",bodyBorder:false,border:false,layout:{type:"hbox",align:"left"},autoRender:true,items:[{xtype:"selectfield",name:"orderAddUpdateOptionId",height:27,store:Ext.AceRoute.store.systemOperationOptionsStore,displayField:"systemOperationOptionName",valueField:"systemOperationOptionId",listeners:{change:{fn:function(src,value){this.systemOperationOptionSelected=value;},scope:this}}},{xtype:"button",text:"Refresh",iconMask:true,stretch:false,scope:this,handler:this.refreshSystemData}]},{xtype:"fieldset",bodyBorder:false,border:false,layout:{type:"hbox",align:"left"},autoRender:true,items:[{xtype:"button",text:"LogOut",iconMask:true,stretch:false,scope:this,handler:this.logout}]}]}]});this.items=[jobsListView,mapPanel,systemPanel];}else{this.on("render",function(){this.el.mask("No internet connection.");},this);}Ext.AceRoute.view.cfg={};Ext.AceRoute.view.cfg.shortUrl=this.shortUrl;Ext.AceRoute.view.cfg.title=this.title;Ext.AceRoute.view.AppTabPanel.superclass.initComponent.call(this);},setMapObjArray:function(mapObjArr){this.mapObjArray=mapObjArr;},setMvcController:function(controller){this._controller=controller;},removeMapTab:function(orderMapPanel,mapId){orderMapPanel.remove(mapId);},insertMapTab:function(appTabPanel,orderMapPanel,orderData,mapObjArray){var map;var _self=this;var posArray=new Array();if(mapObjArray!=null){for(var index=0;index<mapObjArray.length;index++){var geoCode=mapObjArray[index].geoCode;var indexOfComma=geoCode.indexOf(",");var latitude=geoCode.substring(0,indexOfComma);latitude=latitude.trim();var longitude=geoCode.substring(indexOfComma+1,geoCode.length);longitude=longitude.trim();var position=new google.maps.LatLng(latitude,longitude);posArray.push(position);}map=new Ext.Map({id:"mapId",mapOptions:{center:new google.maps.LatLng(latitude,longitude),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.DEFAULT}},listeners:{maprender:function(comp,map){var pos;for(var index=0;index<mapObjArray.length;index++){if(mapObjArray[index].geoCode){var image=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_spin&chld=1|0|"+mapObjArray[index].iconClr+"|10|b|"+mapObjArray[index].seqLabel);var geoCode1=mapObjArray[index].geoCode;var indexOfComma1=geoCode1.indexOf(",");var latitude1=geoCode.substring(0,indexOfComma1);latitude1=latitude1.trim();var longitude1=geoCode1.substring(indexOfComma1+1,geoCode1.length);longitude1=longitude1.trim();var marker=new google.maps.Marker({position:posArray[index],title:"My Current Location",shadow:shadow,icon:image,map:map});var message="<font size='2'>"+"<b>"+mapObjArray[index].seqLabel+"</b><br/>"+mapObjArray[index].orderName+"<br/>"+mapObjArray[index].orderAddress+"<br/>"+mapObjArray[index].orderStartDate+" "+mapObjArray[index].orderStartTime+"</font>"+"<input type='button' name='orderDetails' value='Order' class='x-button-label' onclick='showOrderDetails("+mapObjArray[index].orderId+")'/>"+"<input type='button' name='navigate' value='Navigate' class='x-button-label' onclick='navigate("+latitude1+","+longitude1+")'/>";console.log(" index "+index+" message "+message);this.attachMessage(map,marker,message,appTabPanel,orderMapPanel,orderData);pos=posArray[index];setTimeout(function(){map.panTo(pos);},1000);}}},scope:this}});appTabPanel.setActiveItem(orderMapPanel,"slide");appTabPanel.doLayout();orderMapPanel.add(map);orderMapPanel.doLayout();}else{var geoCode=orderData.site_geocode;var site_addr=orderData.site_addr;var start_dateWithoutTime=orderData.start_dateWithoutTime;var start_time=orderData.start_time;var orderDataComplete=orderData.data;var indexOfComma=geoCode.indexOf(",");var latitude=geoCode.substring(0,indexOfComma);latitude=latitude.trim();var longitude=geoCode.substring(indexOfComma+1,geoCode.length);longitude=longitude.trim();var position=new google.maps.LatLng(latitude,longitude);var current_date=new Date();var start_date=new Date(orderDataComplete.start_date);var end_date=new Date(orderDataComplete.end_date);var order_wkfid=orderDataComplete.order_wkfid;var iconClr=CommonUtil.getIconColor(current_date,start_date,end_date,order_wkfid);var image=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_spin&chld=0.75|0|"+iconClr+"|8|b|");var shadow=new google.maps.MarkerImage("img/shadow.png",new google.maps.Size(64,52),new google.maps.Point(0,0),new google.maps.Point(-5,42));map=new Ext.Map({id:"mapId",mapOptions:{center:new google.maps.LatLng(latitude,longitude),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:true,navigationControlOptions:{style:google.maps.NavigationControlStyle.DEFAULT}},listeners:{_self:this,maprender:function(comp,map){var marker=new google.maps.Marker({position:position,title:"My Current Location",shadow:shadow,icon:image,map:map});var message="<font size='2'>"+site_addr.formatAddress(",")+"<br/>"+start_dateWithoutTime+" "+start_time+"</font>"+"<input type='button' name='orderDetails' value='Order' class='x-button-label' onclick='showOrderDetails("+orderData.data.id+")'/>"+"<input type='button' name='navigate' value='Navigate' class='x-button-label' onclick='navigate("+latitude+","+longitude+")'/>";this.attachMessage(map,marker,message,appTabPanel,orderMapPanel,orderData);setTimeout(function(){map.panTo(position);},1000);},scope:this}});appTabPanel.setActiveItem(orderMapPanel,"slide");appTabPanel.doLayout();orderMapPanel.add(map);orderMapPanel.doLayout();}},refreshSystemData:function(){var systemOperationOptionSelected=this.systemOperationOptionSelected;if(typeof systemOperationOptionSelected!=="undefined"){if(systemOperationOptionSelected=="refreshOrders"){var orderListTab=this.getComponent("orderListXmlId");if(typeof orderListTab!=="undefined"){var dateData=orderListTab.dateButtons.items.get(0).dateData;var dateDataString=dateData.toString().replaceAll("-","/");orderListTab.changeDateString(dateDataString,dateData);}}}},logout:function(){if(typeof Ext.getCmp("loginViewPanelId")!=="undefined"){Ext.getCmp("loginViewPanelId").destroy();}Ext.getCmp("systemPanelId").destroy();try{Ext.getCmp("appTabPanel").destroy();}catch(err){console.log("error while destroying appTabPanel "+err);}new Ext.AceRoute.controller.LoginController();Ext.getCmp("loginViewPanelId").doComponentLayout();},attachMessage:function(map,marker,message,appTabPanel,orderMapPanel,orderData){appTabPanelGlobal=appTabPanel;orderMapPanelGlobal=orderMapPanel;orderDataGlobal=orderData;var infowindow=new google.maps.InfoWindow({content:message,size:new google.maps.Size(30,30)});google.maps.event.addListener(marker,"click",function(){infowindow.open(map,marker);});}});